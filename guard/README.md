## Поток данных

### 1. POST /guard/auth/v1/auth (Не защищен)
1. Пользователь обращается в guard, передавая свой telegram_id. Пользователя
авторизует, добавляет его в таблицу пользователей, в случае, если его там еще не было.
2. Сохраняет refresh токенв базу данных и кэш, а также записывает версию refresh токен для указанного пользователя.
3. Если у пользователя уже был выписан refresh токен, то он отзывается(удаляем из кэша и помечаем в базе данных).
4. Возвращает в ответе новые access и refresh токены.

### 2. POST /guard/auth/v1/refresh (Не защищен)
1. Пользователь передает refresh_token. В случае если он истек, был отозван или не является
валидным, то запрос отклоняется.
2. Если же токен валидный, то он отзывается, а пользователю выдается новая пара access и 
refresh токенов. Таким образом refresh токены ротируются после каждого запроса.

### 3. POST /guard/auth/v1/auth-admin (Не защищен)
Ручка для получения access токена с правами администратора. Пользователь передает
telegram_id и секрет админа, который присвоен этому telegram_id. Если хэш секрета совпадает, то
пользователю выдается админский access token. Refresh токены не выдаются из-за их долгого 
времени жизни, что может быть опасно для токенов с правами администратора, даже с учетом
ротации refresh токенов.

### 4. DELETE /guard/auth/v1/token_revoke/{user_id} (Требует админский access token)
Отзывает все refresh токены указанного пользователя. В базе данных все токены отмечаются явно,
а в кэше для ускорения работы как раз используются версии токенов для пользователя. Для этого 
пользователя номер версии повышается на 1 и теперь все refresh токены с версией меньше этой будут считаться
отозванными. 


## Создание секретов для администраторов
Для выдачи прав администратора необходимо запустить сервисы kafka, guard и envoy.
Envoy и kafka в данном случае опциональны. Их следует запускать, чтобы бот envoy мог
самостоятельно отправить секрет пользователю с указанным telegram_id. Однако скрипт выведет
секрет в консоль, так что можно будет передать его вручную, если есть необходимость.

После запуска сервисов необходимо перейти в папку *admin_cli* и выполнить следующую команду:
```commandline
docker compose run --rm admin_cli --telegram-id <telegram_id of a user>
```

Если вы все сделали правильно, то вернется секрет для этого пользователя, который
он может использовать для получения админских access токенов.

Скрипт обращается к скрытому эндпоинту /guard/internal/v1/init_admin. В нем создается
пользователь с правами администратора или повышаются права уже существующего пользователя.
Также генерируется секрет. При повторном запуске скрипта для того же пользователя прошлый секрет
будет отозван.