# Проект 17. Предсказание стоимости акций
В качестве актива выбраны акции банковского сектора Российского рынка

## Описание проекта
Проект направлен на получение практического опыта применения ML для прогнозирования стоимости акций.
Задача разработать и сравнить методы прогнозирования цен акций банковского сектора российского рынка.
Разработать сервис для торговли на бирже применяющий разарботанные модели.

## Команда
- Куратор: Дмитрий Качкин
- Участник: Косенков Роман
- Участник: Шиндяпкин Илья
- Участник: Попандопуло Костас


## Структура сервиса
| Сервис                           | Краткое описание                                                                                                                                                                          |
|----------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| [**postman**](postman/README.md) | Прокси-сервис, принимающий запросы от пользователей через envoy или напрямую. Запрашивает прогнозы по активам у magician, и возвращает их пользователям. Собирает статистику по запросам. |
| [**guard**](guard/README.md)     | Сервис аутентификации и управления токенами пользователей. Предоставляет access и refresh токены. Отвечает за выдачу админских секретов.                                                  |
| [**envoy**](envoy/README.md)     | Telegram-бот для взаимодействия с пользователями. Принимает команды и отображает прогнозы.                                                                                                |
| **scavenger**                    | Сервис получения исторических данных для прогнозов (candles, тикеры).                                                                                                                     |
| **magician**                     | ML-cервис, выполняющий прогнозы для переданных параметров.                                                                                                                                |



Общение между сервисами идет, как через обычный REST, так и через сообщения Kafka. Для более
подробного потока данных можно обратиться к документации отдельных сервисов.

Для kafka настроен ui на порте 8080, дабы можно было отслеживать топики, обмен сообщениями
и состояние брокеров. Были сделаны реплики и партиции для повышения отказоустойчивости системы.

Для каждого сервиса можно открыть OPEN API схему, с возможностью отправки запросов и авторизации.
Порты сервисов можно посмотреть в docker-compose каждого из сервисов.

Используется ORM на базе SQLAlсhemy, и образ Posgres для базы данных. Работа бд осуществляется
в асинхронном формате. Для осуществления миграций используется alembic. Миграции автоматически
применяются при необходимости при запуске контейнеров FastAPI.

Для защиты эндпоинтов были добавлены JWT токены, для обычных пользователей и администраторов.

Redis конфигурируется с помощью генерируемого ACL-конфига, позволяя разделять области доступа
для микросервисов. 

Чувствительные данные необходимые для работы сервисов хранятся в .env файлах. Для корректной работы
не забудьте их заполнить! Примеры структуры файлов приложены в .env_example.

Конфигурации отвечающие за бизнес-логику вынесены в отдельные yaml файлы и подгружаются при
работе сервисов.

Для сервисов настроено логгирование, в том числе с записью в файл в формате jsonl, дабы в дальнейшем
логи было удобней сохранять и анализировать системами вроде ElasticSearch.

## Использование
Для развертывания всех сервисов необходимо запустить docker-compose up в корне проекта.

Для просмотра изменений в redis можно использовать:
```commandline
docker exec -it redis redis-cli
KEYS <ACL service scope>:*
GET <key>
```

Пример данных:
```commandline
docker exec -it redis redis-cli
127.0.0.1:6379> KEYS postman:*
1) "postman:forecasts:c153ed9f864d806e2ce747f51ab27515a5911818dac258b66b581285db30471b"
2) "postman:forecasts:da2856e8ee7edc58557d817be63c24b12f7b4a16faa1ad7e3a17c4f29bf16c37"
3) "postman:forecasts:9cb47b462876ee2f00b6753ddfbf51ae7cc9b827e9e3f068e7c746dba7022a26"
127.0.0.1:6379> GET postman:forecasts:c153ed9f864d806e2ce747f51ab27515a5911818dac258b66b581285db30471b
"{\"isin\":\"RU0009029540\",\"forecast_period\":7,\"time_frame\":\"1w\",\"forecast_price\":50777.50189792535,\"model\":\"auto_arima\",\"provide_plot\":false,\"forecast_confidence\":null,\"forecast_plot\":null}"
```

Для просмотра postgres базы данных:
```commandline
docker exec -it <container_name> psql -U <user> -d <data base name>
# Просмотр существующих таблиц
\dt
# Любые SQL запросы
SELECT * FROM refresh_tokens;
```

Пример данных:
```commandline
docker exec -it guard_db psql -U guard_admin -d guard_db
guard_db-# \dt
               List of relations
 Schema |      Name       | Type  |    Owner
--------+-----------------+-------+-------------
 public | admin_secret    | table | guard_admin
 public | alembic_version | table | guard_admin
 public | refresh_tokens  | table | guard_admin
 public | users           | table | guard_admin
(4 rows)
guard_db=# SELECT * FROM users;
                  id                  | telegram_id | role  |          created_at
--------------------------------------+-------------+-------+-------------------------------
 fd785d0a-fed6-4f60-ba5e-35d91fe98f62 |   742170129 | USER   | 2025-12-31 14:31:23.00018+00
 886de5ef-8405-46e9-90d8-d9eca64e434e |           0 | ADMIN  | 2025-12-31 16:02:38.684468+00

```